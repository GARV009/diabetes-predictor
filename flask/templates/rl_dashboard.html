{% extends "base_dashboard.html" %}

{% block title %}RL Model Performance - Health Manager{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ü§ñ AI Model Learning Dashboard</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">Real-time reinforcement learning system performance</p>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Total Predictions -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm">Total Predictions</p>
                    <p class="text-4xl font-bold mt-2" id="totalPredictions">0</p>
                </div>
                <div class="text-5xl opacity-20">üìä</div>
            </div>
        </div>

        <!-- Model Accuracy -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm">Model Accuracy</p>
                    <p class="text-4xl font-bold mt-2" id="modelAccuracy">--</p>
                </div>
                <div class="text-5xl opacity-20">‚úì</div>
            </div>
        </div>

        <!-- Correct Predictions -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm">Correct Predictions</p>
                    <p class="text-4xl font-bold mt-2" id="correctPredictions">0</p>
                </div>
                <div class="text-5xl opacity-20">‚úÖ</div>
            </div>
        </div>

        <!-- Confidence Multiplier -->
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm">Confidence Adjustment</p>
                    <p class="text-4xl font-bold mt-2" id="confidenceMultiplier">1.0x</p>
                    <p class="text-xs text-orange-100 mt-1">RL Impact Factor</p>
                </div>
                <div class="text-5xl opacity-20">‚ö°</div>
            </div>
        </div>
    </div>

    <!-- Learning Progress Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-100 dark:border-gray-700 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">üìà Model Learning Progress</h2>
        
        <!-- Accuracy Gauge -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Prediction Accuracy</h3>
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-6 h-80">
                    <canvas id="accuracyChart"></canvas>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-3 text-center">
                    How often the model makes correct predictions
                </p>
            </div>

            <!-- Confidence Impact -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Confidence Multiplier Effect</h3>
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-6">
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-700 dark:text-gray-300">Model Base Confidence</span>
                                <span class="font-semibold text-gray-900 dark:text-white">1.0x</span>
                            </div>
                            <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-700 dark:text-gray-300">RL Adjustment Factor</span>
                                <span class="font-semibold text-orange-600 dark:text-orange-400" id="rlFactorDisplay">+0.0x</span>
                            </div>
                            <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2">
                                <div class="bg-orange-500 h-2 rounded-full" id="rlFactorBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="border-t border-gray-300 dark:border-gray-600 pt-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-semibold text-gray-900 dark:text-white">Final Risk Score</span>
                                <span class="font-bold text-green-600 dark:text-green-400 text-xl" id="finalScoreDisplay">1.0x</span>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">
                                Risk scores are multiplied by this factor to account for model learning
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accuracy Trend -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900 dark:to-purple-900 rounded-lg p-6 border border-blue-100 dark:border-blue-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Accuracy Trend Over Time</h3>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4">
                <canvas id="accuracyTrendChart" height="80"></canvas>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                üìä Shows how model accuracy evolves as it receives more user feedback
            </p>
        </div>
    </div>

    <!-- How RL Works -->
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900 dark:to-pink-900 rounded-xl shadow-sm p-8 border border-purple-100 dark:border-purple-700 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">üß† How Reinforcement Learning Works Here</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-purple-100 dark:border-purple-700">
                <div class="text-3xl mb-3">1Ô∏è‚É£</div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Prediction Made</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm">
                    Model predicts your diabetes risk and suggests you provide feedback
                </p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-purple-100 dark:border-purple-700">
                <div class="text-3xl mb-3">2Ô∏è‚É£</div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">You Provide Feedback</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm">
                    After visiting a doctor, you report whether prediction was accurate
                </p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-purple-100 dark:border-purple-700">
                <div class="text-3xl mb-3">3Ô∏è‚É£</div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">System Learns</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm">
                    RL adjusts confidence multiplier to improve future predictions
                </p>
            </div>
        </div>

        <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg p-6 border-2 border-purple-200 dark:border-purple-700">
            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">üìä Confidence Multiplier Formula:</h4>
            <div class="bg-gray-100 dark:bg-gray-700 rounded p-3 font-mono text-sm text-gray-800 dark:text-gray-200">
                Multiplier = 0.8 + (Model Accuracy √ó 0.4)<br>
                <span class="text-xs text-gray-600 dark:text-gray-400">Range: 0.8x (low accuracy) to 1.2x (high accuracy)</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                ‚úì Higher accuracy = more confident in future risk scores<br>
                ‚úó Lower accuracy = more cautious with risk scores
            </p>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-100 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">üìã System Statistics</h2>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 rounded-lg p-6">
                <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Total Predictions</p>
                <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2" id="statTotal">0</p>
            </div>

            <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 rounded-lg p-6">
                <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Correct</p>
                <p class="text-3xl font-bold text-green-600 dark:text-green-400 mt-2" id="statCorrect">0</p>
            </div>

            <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900 dark:to-red-800 rounded-lg p-6">
                <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Incorrect</p>
                <p class="text-3xl font-bold text-red-600 dark:text-red-400 mt-2" id="statIncorrect">0</p>
            </div>

            <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900 dark:to-purple-800 rounded-lg p-6">
                <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Success Rate</p>
                <p class="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-2" id="statSuccessRate">0%</p>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center">
        <a href="{{ url_for('main.dashboard') }}" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadRLStats() {
    try {
        const response = await fetch('{{ url_for("prediction.get_rl_stats") }}');
        const stats = await response.json();
        
        // Update metrics
        document.getElementById('totalPredictions').textContent = stats.total_predictions;
        document.getElementById('correctPredictions').textContent = stats.correct_predictions;
        document.getElementById('modelAccuracy').textContent = stats.accuracy.toFixed(1) + '%';
        document.getElementById('confidenceMultiplier').textContent = stats.confidence_adjustment.toFixed(2) + 'x';
        
        // Update confidence factor display
        const adjustment = stats.confidence_adjustment - 1;
        const adjustmentPercent = adjustment > 0 ? '+' + (adjustment * 100).toFixed(1) : (adjustment * 100).toFixed(1);
        document.getElementById('rlFactorDisplay').textContent = adjustmentPercent + '%';
        
        // RL Factor Bar (center at 50% for neutral 1.0x)
        const barWidth = ((stats.confidence_adjustment - 0.8) / 0.4) * 100;
        document.getElementById('rlFactorBar').style.width = barWidth + '%';
        document.getElementById('finalScoreDisplay').textContent = stats.confidence_adjustment.toFixed(2) + 'x';
        
        // Stats
        const incorrect = stats.total_predictions - stats.correct_predictions;
        document.getElementById('statTotal').textContent = stats.total_predictions;
        document.getElementById('statCorrect').textContent = stats.correct_predictions;
        document.getElementById('statIncorrect').textContent = incorrect;
        document.getElementById('statSuccessRate').textContent = stats.accuracy.toFixed(0) + '%';
        
        // Accuracy pie chart
        const accuracyCtx = document.getElementById('accuracyChart')?.getContext('2d');
        if (accuracyCtx) {
            new Chart(accuracyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Correct', 'Incorrect'],
                    datasets: [{
                        data: [stats.correct_predictions, incorrect],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        // Accuracy trend line chart
        if (stats.recent_accuracy_history && stats.recent_accuracy_history.length > 0) {
            const trendCtx = document.getElementById('accuracyTrendChart')?.getContext('2d');
            if (trendCtx) {
                const labels = stats.recent_accuracy_history.map((h, i) => `Check ${i + 1}`);
                const data = stats.recent_accuracy_history.map(h => (h.accuracy * 100).toFixed(1));
                
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Model Accuracy %',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { suffix: '%' }
                            }
                        }
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error loading RL stats:', error);
    }
}

// Load stats on page load
loadRLStats();

// Refresh stats every 10 seconds
setInterval(loadRLStats, 10000);
</script>
{% endblock %}
